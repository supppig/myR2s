name: 专属r2s-lean-openwrt

on:
  schedule:
    - cron: 26 18 * * *
  workflow_dispatch:
env:
  TZ: Asia/Shanghai
  ZIP_PWD: ${{ secrets.ZIP_PWD }}

jobs:
  build_my_R2s:
    runs-on: ubuntu-18.04
    if: github.event.repository.owner.id == github.event.sender.id
    steps:
      - uses: actions/checkout@v2

      - name: 初始化
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sh 1-init.sh

      - name: 添加额外package
        run: |
          cd lede
          sh 2-extraPkg.sh

      - name: 更新feeds
        run: |
          cd lede
          sh 3-feeds.sh

      - name: 预下载
        run: |
          cd lede
          sh 4-download.sh

      - name: 构建
        run: |
          cd lede
          sh 5-build.sh

      - name: 重打包固件
        run: |
          cd lede
          sh 6-repack.sh

      - name: 上传固件
        run: |
          cd lede
          sh 7-upload.sh
      # - name: 创建Release
      #   id: create_release
      #   uses: actions/create-release@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.sec_token }}
      #   with:
      #     tag_name: ${{ steps.assemble_artifact.outputs.release_tag }}
      #     release_name: 自动发布 ${{ steps.assemble_artifact.outputs.release_tag }}
      #     draft: false
      #     prerelease: false
      # - name: 上传Release附件
      #   id: upload-release-asset
      #   uses: actions/upload-release-asset@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.sec_token }}
      #   with:
      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
      #     asset_path: ./artifact.zip
      #     asset_name: ${{ steps.assemble_artifact.outputs.release_tag }}-ROM.zip
      #     asset_content_type: application/zip
      # - name: 删除旧Releases
      #   uses: dev-drprasad/delete-older-releases@v0.1.0
      #   with:
      #     keep_latest: 5
      #     delete_tags: true
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.sec_token }}
